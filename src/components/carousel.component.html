<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<dom-module id="app-carousel">
      <template>
      <style>
      :host {
            display: flex;
            position: relative;
            --carousel-height: 100%;
            --carousel-ui-color: var(--app-white);
            --carousel-ui-ink-color: var(--app-primary-color);
            --border-radius: var(--carousel-border-radius, 3px);
            contain: paint;
            overflow: hidden;
            border-radius: var(--border-radius);
      }

      .noImageIcon {
            color: var(--app-white);
            height: 50px;
            width: 50px;
      }

      .noPicture {
            width: 100%;
            height: 100%;
            background-color: var(--app-light-grey);
            transition: opacity .2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            position: absolute;
            top: 0;
            left: 0;
      }

      #pictures {
            display: flex;
            overflow: hidden;
            height: var(--carousel-height);
            width: 100%;
            position: relative;

            border-radius: var(--border-radius);
      }

      #pictures > .picContainer {
            flex-shrink: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            will-change: transform;

            border-radius: var(--border-radius);
      }

      .picLink {
            display: block;
            position: absolute;
            top: 10px;
            right: 18px;
            z-index: 100;
            color: var(--app-white);
            text-decoration: none;

            transition: opacity .2s ease;
      }

      .itemText {
            position: absolute;
            top: 10px;
            left: 18px;
            z-index: 100;
            color: var(--app-white);
            display: none;
            transition: opacity .2s ease;
      }

      #pictures iron-image {
            border-radius: var(--border-radius);
      }

      .leftShadow {
            box-shadow: -6px 0px 12px -3px rgba(0, 0, 0, 0.4);
      }

      .rightShadow {
            box-shadow: 6px 0px 12px -3px rgba(0, 0, 0, 0.4);
      }

      .gradientLayer {
            width: 100%;
            height: 100%;
            background-image:
            -webkit-linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0)),
            -webkit-linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.3));
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
      }

      #ui {
            position: absolute;
            left: 0;
            z-index: 4;

            height: var(--carousel-height);
            width: 100%;

            display: flex;
            flex-direction: column;

            transition: opacity .2s ease;
      }

      #mainActions {
            display: flex;
            flex-grow: 1;
            align-items: center;
      }

      #navButtons{
            display: flex;
            flex-grow: 1;
            justify-content: space-between;
      }

      #bottomActions {
            display: flex;
            justify-content: space-between;
      }

      #autoplayer, #spacer {
            height: 40px;
            width: 40px;
      }

      #bullets {
            display: inline-block;
      }

      paper-radio-button {
            --paper-radio-button-checked-color: var(--carousel-ui-color, white);
            --paper-radio-button-checked-ink-color: var(--carousel-ui-ink-color, white);
            --paper-radio-button-unchecked-color: var(--carousel-ui-color, white);
            --paper-radio-button-unchecked-ink-color: var(--carousel-ui-ink-color, white);
      }

      paper-icon-button {
            height: 70px;
            width: 70px;
            color: var(--carousel-ui-color, white);
            --paper-icon-button-ink-color: var(--carousel-ui-ink-color, white);
      }

      [transparent] {
            opacity: 0;
            pointer-events: none;
      }

      @media (min-width: 640px) {
            .itemText {
                  display: block !important;
            }
      }
      </style>

      <div class="noPicture" transparent$="[[hasPicturesReady]]">
            <iron-icon class="noImageIcon" icon="visibility-off"></iron-icon>
      </div>

      <div id="pictures">
            <template is="dom-repeat" items="[[items]]" as="oneItem">
                  <div id="[[oneItem.id]]" class="picContainer">
                        <iron-image
                        style$="[[_computeInlineStyles(carouselHeight, carouselWidth)]]"
                        placeholder="[[oneItem.base64]]"
                        sizing="cover"
                        preload src="[[oneItem.src]]"
                        fade></iron-image>
            </div>
      </template>
</div>

<div class="gradientLayer">
</div>

<div id="ui" on-track='_handlePicTrack'>
      <template is="dom-repeat" items="[[items]]" as="oneItem">
            <template is="dom-if" if="[[_showTitle(oneItem)]]">
                  <a transparent$="[[_computeItemUiStyle(oneItem.id, selectedItemName, isAnimating)]]" class="picLink" href="[[oneItem.href]]" tabindex="-1"><paper-button >[[oneItem.linkTitle]]</paper-button></a>
            </template>
      </template>

      <template is="dom-repeat" items="[[items]]" as="oneItem">
            <template is="dom-if" if="[[_showText(oneItem)]]">
                  <paper-button transparent$="[[_computeItemUiStyle(oneItem.id, selectedItemName, isAnimating)]]" class="itemText">[[oneItem.text]]</paper-button>
            </template>
      </template>

      <div id="mainActions">
            <div id="navButtons">
                  <paper-icon-button disabled='[[_disableUi(isAnimating, items)]]' on-tap="_slide" data-direction="left" icon="icons:chevron-left"></paper-icon-button>
                  <paper-icon-button disabled='[[_disableUi(isAnimating, items)]]' on-tap="_slide" data-direction="right" icon="icons:chevron-right"></paper-icon-button>
            </div>
      </div>

      <div id="bottomActions">
            <paper-icon-button id="autoplayer" disabled='[[_disableUi(isAnimating, items)]]' on-tap="_togglePlayer" icon$="[[_computePlayerIcon(isPlaying)]]"></paper-icon-button>

            <paper-radio-group id="bullets" selected="{{selectedItemName}}">
                  <template is="dom-repeat" items="[[items]]" as="onePic">
                        <paper-radio-button disabled="[[_disableUi(isAnimating, items)]]" name="[[onePic.id]]"></paper-radio-button>
                  </template>
            </paper-radio-group>
            <div id="spacer"></div>
      </div>
</div>

</template>
<script>
'use strict';
Polymer({
      is: 'app-carousel',

      properties: {

            hasPicturesReady: {
                  type: Boolean,
                  value: false,
                  reflectToAttribute: true,
            },

            items: {
                  type: Array,
                  observer: '_onRawItemsChange',
                  value: [],
            },

            currPosition: {
                  type: Number,
            },

            activeDirection: {
                  type: String,
                  value: 'none',
            },

            isAnimating: {
                  type: Boolean,
                  value: false,
            },

            carouselWidth: Number,
            carouselHeight: Number,

            selectedItemName: {
                  type: String,
                  observer: '_onSelectionChange',
            },

            isPlaying: {
                  type: Boolean,
                  value: true,
            },

            picsPositions : {
                  type: Object,
                  value: {},
            },

            config: {
                  type: Object,
                  readOnly: true,
                  value: {
                        transition: 'transform .3s ease-in-out',
                        autoplayInterval: 4000,

                  }
            }
      },

      behaviors: [ Polymer.IronResizableBehavior ],
      listeners: {
            "iron-resize": "onResize",
            "iron-select": "onIronSelect"
      },

      ready: function() {
            this.setScrollDirection('y', this.$.ui);
            this._initAutoPlay();
      },

      onResize: function (e) {
            if(this.offsetParent) {
                  this.carouselWidth = this.offsetWidth;
                  this.carouselHeight = this.offsetHeight;
            }
      },

      onIronSelect: function (e) {
            e.stopPropagation();
      },

      _showTitle: function(item) {
            return typeof item.linkTitle !== 'undefined';
      },

      _showText: function(item) {
            return typeof item.text !== 'undefined';
      },

      _disableUi: function(anim, items) {
            return anim || items.length < 2;
      },

      _onRawItemsChange: function (newItems, oldItems) {
            if (!(newItems instanceof Array) || 0 == newItems.length) {
                  this.hasPicturesReady = false;
                  return;
            }

            this.currPosition = 0;
            this.selectedItemName = newItems[0].id;

            var _this = this;
            var init = function () {
                  _this.$$('#' + _this.selectedItemName).style.zIndex = 1;
                  _this.hasPicturesReady = true;
            };

            Polymer.RenderStatus.afterNextRender(this, init);

      },

      _onSelectionChange: function (newItemName, oldItemName) {
            if(!newItemName || this.isAnimating) return;
            this.isAnimating = true;
            var newIndex = this._findPosition(newItemName);
            var direction = this._computeDirection(newIndex);
            this._moveViewPort(newIndex, direction);
            this._preventFreeze();
      },

      _preventFreeze: function() {
            var _this = this;
            setTimeout(function() {
                  _this.isAnimating = false;
            }, 300)
      },

      _slide: function (e) {
            this.activeDirection = e.target.getAttribute('data-direction') || e.target.parentNode.getAttribute('data-direction');
            'left' == this.activeDirection ? this.$$('#bullets').selectPrevious() : this.$$('#bullets').selectNext();
      },

      _moveViewPort: function (nextPos, direction) {
            if (this.currPosition == nextPos) {
                  return this.isAnimating = false;
            }
            var _this = this;

            // Load current pic and next one to display
            var initialPicElem = this._getDomElement(this.currPosition);
            var nextPicElem = this._getDomElement(nextPos);

            // Set transitional position according to direction
            var transitionalPos, shadowClass;
            if ('left' == direction) {
                  transitionalPos = '-100';
                  shadowClass = 'rightShadow';
            }
            else {
                  transitionalPos = '100';
                  shadowClass = 'leftShadow';
            }

            // Move next pic to the correct position (left or right)
            nextPicElem.style.transition = 'none';
            this.transform('translateX('+ transitionalPos +'%)', nextPicElem);
            nextPicElem.style.zIndex = 2;
            initialPicElem.style.zIndex = 1;
            nextPicElem.classList.add(shadowClass);

            var onTransitionEnd = function() {
                  // Replace old pic in stack + change focus
                  initialPicElem.style.zIndex = 0;
                  nextPicElem.style.zIndex = 1;
                  nextPicElem.classList.remove(shadowClass);

                  // Update current status
                  _this.currPosition = nextPos;
                  _this.activeDirection = 'none';
                  _this.isAnimating = false;
            };
            // Slide pics
            requestAnimationFrame(function() {
                  _this._attachTransitionEventListener(nextPicElem, onTransitionEnd);
                  requestAnimationFrame(function() {
                        nextPicElem.style.transition = _this.config.transition;
                        _this.transform('none', nextPicElem);
                  })
            });
      },

      _handlePicTrack: function (e) {
            var _this = this;
            if(!this.hasPicturesReady || this.items.length < 2) return;
            switch(e.detail.state) {
                  case 'start':
                  if (this.isAnimating) return this.init = false;

                  this.isAnimating = true;
                  this.isPlaying = false;
                  this._toggleUI(false);
                  this.detectedPics = this._preparePics();
                  this.init = true;
                  break;

                  case 'track':
                  if (!this.init) return;

                  if(Math.abs(e.detail.dx) <= this.carouselWidth) {
                        if (0 < e.detail.dx) {
                              this.transform( 'translateX(-100%)' , this.detectedPics.next);
                              this.transform( 'translateX(calc(-100% + '+ e.detail.dx +'px))' , this.detectedPics.prev);
                        }
                        else {
                              this.transform( 'translateX(100%)' , this.detectedPics.prev);
                              this.transform( 'translateX(calc(100% - '+ Math.abs(e.detail.dx) +'px))' , this.detectedPics.next);
                        }
                  }
                  break;

                  case 'end':
                  if(!this.init) return;
                  var capReached = Math.abs(e.detail.dx) > (_this.carouselWidth / 3);
                  if (e.detail.dx > 0) {
                        _this._endDrag(_this.detectedPics.prev, capReached, _this.detectedPics.prevIndex, 'left');
                  } else {
                        _this._endDrag(_this.detectedPics.next, capReached, _this.detectedPics.nextIndex, 'right');
                  }

                  break;
            }
      },

      _endDrag: function (elem, capReached, nextPos, direction) {
            var _this = this;
            var previousSelectedItem = _this.currPosition;

            // Callback when the transition end
            var onTransitionEnd = function () {
                  _this.detectedPics.next.classList.remove('leftShadow');
                  _this.detectedPics.prev.classList.remove('rightShadow');

                  // Stack correctly the pics
                  _this._getDomElement(previousSelectedItem).style.zIndex = 0;
                  _this._getDomElement(_this.currPosition).style.zIndex = 1;
                  // Update bullet selection
                  _this.selectedItemName = _this.items[_this.currPosition].id;

                  _this._toggleUI(true);
                  _this.isAnimating = false;
            };

            this._attachTransitionEventListener(elem, onTransitionEnd);

            requestAnimationFrame(function () {
                  elem.style.transition = _this.config.transition;
                  if(capReached) {
                        _this.currPosition = nextPos;
                        _this.transform('none', elem);
                  } else {
                        var translateValue = direction == 'left' ? '-100%' : '100%';
                        _this.transform('translateX(' + translateValue + ')', elem);
                  }
            });
      },

      _attachTransitionEventListener: function(elem, cb) {

            // Create the callback for the listener
            var overloadedCb = function() {
                  elem.removeEventListener('transitionend', overloadedCb, true);
                  elem.style.transition = 'none';
                  if(typeof cb === 'function') {
                        cb();
                  }
            }

            // Attach callback on transition end
            elem.addEventListener('transitionend', overloadedCb, true);
      },

      _preparePics: function () {
            var lastIndex = this.items.length - 1;
            var prevIndex = (0 == this.currPosition) ? lastIndex : this.currPosition - 1;
            var nextIndex = (lastIndex == this.currPosition) ? 0 : this.currPosition + 1;
            // Get items and place them
            var prevItem = this._getDomElement(prevIndex);
            var nextItem = this._getDomElement(nextIndex);

            this.transform('translateX(-100%)', prevItem);
            this.transform('translateX(100%)', nextItem);
            prevItem.classList.add('rightShadow');
            nextItem.classList.add('leftShadow');
            prevItem.style.zIndex = 2;
            nextItem.style.zIndex = 2;

            return {
                  next: nextItem,
                  nextIndex: nextIndex,
                  prev: prevItem,
                  prevIndex: prevIndex,
            }
      },

      _getDomElement: function (index) {
            return this.$$('#'+this.items[index].id);
      },

      _toggleUI: function (isVisible) {
            this.$.ui.style.opacity = (isVisible) ? 1 : 0;
      },

      _findPosition: function (itemName) {
            for (var i = 0; i < this.items.length; i++) {
                  if (itemName == this.items[i].id) {
                        return i;
                  }
            }
            return -1;
      },

      _computeDirection: function (toIndex) {
            if ('none' != this.activeDirection) {
                  return this.activeDirection
            }
            else {
                  return toIndex < this.currPosition ? 'left' : 'right';
            }
      },

      _computeInlineStyles: function (height, width) {
            return 'height: '+ height +'px; width: '+ width +'px;';
      },

      _computeItemUiStyle: function (id, selectedItemName, isAnimating) {
            return (isAnimating || id != selectedItemName);
      },

      _computePlayerIcon: function (isPlaying) {
            return isPlaying ? 'av:pause' : 'av:play-arrow';
      },

      _togglePlayer: function (e) {
            this.isPlaying = ! this.isPlaying;
      },

      _initAutoPlay: function () {
            var _this = this;
            setInterval(function () {
                  if (_this.offsetParent !== null && _this.isPlaying && !_this.isAnimating) {
                        _this.activeDirection = 'right';
                        _this.$$('#bullets').selectNext();
                  }
            }, this.config.autoplayInterval);
      },

});
</script>
</dom-module>
